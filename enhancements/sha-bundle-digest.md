---
title: SHA-Bundle-Digest
authors:
- "@theishshah"
reviewers:
- @camilamacedo86 
- @joelanford 
- @jmrodri
- @ryantking 
- @tlwu2013 
approvers:
- @tlwu2013 
- @jmrodri
- @joelanford 

creation-date: 2022-01-14

last-updated: 2022-01-14

status:implementable

---

# Add support for SHA-based Digest for Images

## Summary

Currently, operators generated by `operator-sdk` will store and retrieve container images based on the image name and the image tag in the bundle. This EP adds support to `operator-sdk` such that images can be stored and retrieved in the bundle with an image name and an image digest as an optional replacement for a tag. Image digests are SHA-256 sums that are hashed from the image layer therefore uniquely identifying one specific image.

## Motivation

Users in air-gapped (disconnected) environments are currently unable to get images based on tags, and can only access local registries based on the digest.

This set of changes will allow SDK users in air-gapped (disconnected) environments to generate bundles with the image digest. This change is necessary due to non-deterministic behavior with images identified via tags, this issue specifically occurs in the OCP registry due to how the digest is generated with tag name as inputs.

### Goals

- Allow users to specify additional images to resolve digests via an environment variable.
- Add the ability to resolve image digests from image tag dynamically using local docker registry.
- OPEN QUESTION: Store digest and tag mappings in file so that user-written code can resolve tags to digest.

### Non-Goals

- Automated migration of existing `operator-sdk` based operators from image tags to image digests.
- Identify locations in user code that reference images by tag.

## Proposal

- Add `--image-digests` flag to `make bundle` in order to enable this feature to be run.
- During bundle generation, discover all environment variables that begin with `RELATED_IMAGE_` then resolve the tags to digests. These variables should be set in `config/manager/manager.yaml` as suggested in [https://master.sdk.operatorframework.io/docs/best-practices/common-recommendation/#other-common-suggestions](https://master.sdk.operatorframework.io/docs/best-practices/common-recommendation/#other-common-suggestions).
- Update CSV relatedImages with resolved image tags to digests

```yaml
Image w/ traditional tags
- name: RELATED_IMAGE_che_server_secure_exposer_jwt_proxy_image
  value: quay.io/eclipse/che-jwtproxy:0.10.0

Image w/ SHA based digest
- name: RELATED_IMAGE_single_host_gateway
  value: quay.io/eclipse/che--traefik:v2.5.0-eb30f9f09a65cee1fab5ef9c64cb4ec91b800dc3fdd738d62a9d4334f0114683

```

### Risks and Mitigations

Since the feature is opt-in, it carries the risk of the end-user enabling it without a correct understanding of the feature and its implications. This can be mitigated with clear documentation both on the website and in the CLI help section.

## Design Details

- Add a `--image-digests` flag to the `operator-sdk generate bundle` command that will enable this functionality.
- Add a variable to the generated `Makefile` called `USE_IMAGE_DIGESTS` that defaults to `false` and when enabled, it passes the `--use-image-digests` flag to `operator-sdk generate bundle`.
- When `operator-sdk generate-bundle` is called with the `--use-image-digests` flag enabled, it will execute the following logic.
  1. Search the environment that is defined in the `manager.yaml` file for all variables that begin with `RELATED_IMAGE_` to build a list of images that need to have tags resolved to digests along with the Operatorâ€™s main image and rbac-proxy image.
  1. For each image in the list, it will use `operator-manifest-tools` [https://github.com/operator-framework/operator-manifest-tools](https://github.com/operator-framework/operator-manifest-tools) to resolve the image tag to a digest
  1. When building the cluster CSV, all images that have been identified as needing a digest instead of a tag should have that digest as an annotation in the CSV.

### Test Plan

The resulting artifact of this EP will be a cluster CSV with image digests instead of tags in the image definitions as well as digest annotations. This feature will need an integration test that veifies that the knobs we provide to enable and configure image digests generates an expected CSV. The expected CSV will be manually created based on the expectations for how the feature should work. We can use this CSV in existing Operator Registry testing setups to verify that OPM correctly renders it.

## Implementation History

There has been no implementation to this point.

## Drawbacks

The original motivation for this feature is used in a disconnected environment with an SDK-built operator, OLM, and OCP. Performing a full E2E test in a complex environment that will need to be specifically built out for this task is out of scope for this SDK EP.

## Alternatives

We are not considering any alternative solutions at this time.
